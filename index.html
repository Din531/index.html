<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sunday Quiz Special for Precis Paper</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #e0f2f7; /* Light blue theme */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        #quiz-container {
            background-color: #ffffff;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            padding: 30px;
            width: 100%;
            max-width: 600px;
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .header-title {
            font-weight: 700;
            font-size: 1.875rem; /* text-3xl */
            line-height: 2.25rem; /* leading-9 */
        }
        .header-contact {
            font-weight: 700;
            font-size: 1.125rem; /* text-lg */
            line-height: 1.75rem; /* leading-7 */
        }
        .blue-button {
            background-color: #3b82f6; /* Blue */
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            border: none;
        }
        .blue-button:hover {
            background-color: #2563eb; /* Darker blue */
        }
        .option-button {
            background-color: #e0f7fa; /* Light cyan */
            color: #212121;
            padding: 12px 20px;
            border-radius: 8px;
            border: 1px solid #b2ebf2;
            text-align: left;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
            display: block;
            width: 100%;
        }
        .option-button:hover:not(.correct):not(.wrong) {
            background-color: #b2ebf2;
            border-color: #80deea;
        }
        .option-button.correct {
            background-color: #a7f3d0; /* Green 300 */
            border-color: #34d399; /* Green 400 */
            color: #065f46;
        }
        .option-button.wrong {
            background-color: #fecaca; /* Red 300 */
            border-color: #ef4444; /* Red 400 */
            color: #991b1b;
        }
        input[type="text"], input[type="password"] {
            width: 100%;
            padding: 10px 15px;
            margin-bottom: 15px;
            border: 1px solid #e0f2f7;
            border-radius: 8px;
            box-sizing: border-box;
            background-color: #f8fafc;
        }
        .timer {
            font-size: 1.25rem; /* text-xl */
            font-weight: 600;
            color: #0284c7; /* Sky 600 */
        }
        .hidden {
            display: none;
        }
        .progress-text {
            font-size: 0.875rem; /* text-sm */
            color: #64748b; /* Slate 500 */
        }
    </style>
</head>
<body class="bg-blue-50">
    <div id="quiz-container" class="max-w-md mx-auto p-6 bg-white rounded-xl shadow-lg">
        <h1 class="header-title text-blue-600">Sunday Quiz Special for Precis Paper</h1>
        <p class="header-contact text-yellow-600">CONTACT: 03188185185</p>

        <!-- Login Section -->
        <div id="login-section">
            <h2 class="text-xl font-semibold mb-4 text-blue-700">Login</h2>
            <input type="text" id="id-input" placeholder="Enter ID" class="mb-3 p-2 border rounded-md">
            <input type="password" id="password-input" placeholder="Enter Password" class="mb-4 p-2 border rounded-md">
            <button id="login-button" class="blue-button w-full">Login</button>
            <p id="login-error" class="text-red-500 mt-2 hidden">Invalid ID or Password.</p>
        </div>

        <!-- Name Entry Section -->
        <div id="name-entry-section" class="hidden">
            <h2 class="text-xl font-semibold mb-4 text-blue-700">Enter Your Name</h2>
            <input type="text" id="name-input" placeholder="Your Name" class="mb-4 p-2 border rounded-md">
            <button id="start-quiz-button" class="blue-button w-full">Start Quiz</button>
            <p id="name-error" class="text-red-500 mt-2 hidden">Please enter your name.</p>
        </div>

        <!-- Quiz Section -->
        <div id="quiz-section" class="hidden">
            <div class="flex justify-between items-center mb-4">
                <span id="question-number" class="progress-text"></span>
                <span id="timer" class="timer">15:00</span>
            </div>
            <p id="question-text" class="text-lg font-medium mb-6 text-gray-800"></p>
            <div id="options-container" class="flex flex-col gap-3 mb-6">
                <!-- Options will be dynamically loaded here -->
            </div>
            <button id="next-button" class="blue-button w-full hidden">Next</button>
        </div>

        <!-- Result Section -->
        <div id="result-section" class="hidden">
            <h2 class="text-2xl font-bold mb-4 text-blue-700">Quiz Complete!</h2>
            <p class="text-lg mb-2 text-gray-700">Candidate: <span id="final-candidate-name" class="font-semibold text-blue-600"></span></p>
            <p class="text-2xl font-bold text-gray-800">Your Score: <span id="final-score" class="text-green-600"></span> / 50</p>
            <p class="text-md text-gray-600 mt-4">You cannot restart the quiz once completed.</p>
        </div>
    </div>

    <script>
        const loginSection = document.getElementById('login-section');
        const nameEntrySection = document.getElementById('name-entry-section');
        const quizSection = document.getElementById('quiz-section');
        const resultSection = document.getElementById('result-section');

        const idInput = document.getElementById('id-input');
        const passwordInput = document.getElementById('password-input');
        const loginButton = document.getElementById('login-button');
        const loginError = document.getElementById('login-error');

        const nameInput = document.getElementById('name-input');
        const startQuizButton = document.getElementById('start-quiz-button');
        const nameError = document.getElementById('name-error');

        const questionNumberSpan = document.getElementById('question-number');
        const timerSpan = document.getElementById('timer');
        const questionText = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const nextButton = document.getElementById('next-button');

        const finalCandidateName = document.getElementById('final-candidate-name');
        const finalScoreSpan = document.getElementById('final-score');

        let quizData = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let userName = '';
        let timeLeft = 15 * 60; // 15 minutes in seconds
        let timerInterval;
        let quizStarted = false;

        // Function to shuffle an array (Fisher-Yates algorithm)
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // Placeholder for API key, will be automatically provided by Canvas
        const apiKey = "";

        // Function to make API calls with exponential backoff
        async function fetchWithBackoff(url, options, retries = 5, delay = 1000) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                if (retries > 0) {
                    await new Promise(res => setTimeout(res, delay));
                    return fetchWithBackoff(url, options, retries - 1, delay * 2);
                } else {
                    console.error("API call failed after multiple retries:", error);
                    throw error;
                }
            }
        }

        // Function to generate MCQs using LLM
        async function generateMCQs(prompt, schema) {
            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });
            const payload = {
                contents: chatHistory,
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: schema
                }
            };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            try {
                const result = await fetchWithBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const json = result.candidates[0].content.parts[0].text;
                    return JSON.parse(json);
                } else {
                    console.error("Unexpected API response structure for MCQs:", result);
                    return [];
                }
            } catch (error) {
                console.error("Error generating MCQs:", error);
                return [];
            }
        }

        // Schemas for MCQ generation
        const mcqSchema = {
            type: "ARRAY",
            items: {
                type: "OBJECT",
                properties: {
                    question: { "type": "STRING" },
                    options: {
                        type: "ARRAY",
                        items: { "type": "STRING" }
                    },
                    correctAnswer: { "type": "STRING" }
                },
                propertyOrdering: ["question", "options", "correctAnswer"]
            }
        };

        async function loadQuizData() {
            // Updated prompts with stronger randomization and length balance directives
            const vocabFPrompt = `Generate 10 multiple-choice questions for vocabulary (5 synonyms and 5 antonyms) of words starting with 'F'. For each question, provide a word, a question (e.g., 'Which word is a synonym of Fickle?' or 'Which word is an antonym of Fickle?'), four distinct options, and the correct answer. Crucially, ensure that the correct answer is truly randomized among the four options for *each* question and its position is never predictable (e.g., not always option 2 or 4). Also, ensure all four options have similar lengths (number of words/characters) to prevent the correct answer from being obvious due to length.`;
            const idiomsCPrompt = `Generate 10 multiple-choice questions for English idioms starting with 'C'. For each question, provide an idiom, a question asking for its meaning, four options (one being the correct meaning, three plausible distractors), and the correct answer. Crucially, ensure that the correct answer is truly randomized among the four options for *each* question and its position is never predictable (e.g., not always option 2 or 4). Also, ensure all four options have similar lengths (number of words/characters) to prevent the correct answer from being obvious due to length.`;
            const punctuationPrompt = `Generate 10 multiple-choice questions about punctuation usage. Each question should present a sentence or scenario, a question asking for correct punctuation, four options (one with correct punctuation, three with plausible errors), and the correct answer. Crucially, ensure that the correct answer is truly randomized among the four options for *each* question and its position is never predictable (e.g., not always option 2 or 4). Also, ensure all four options have similar lengths (number of words/characters) to prevent the correct answer from being obvious due to length.`;
            const activePassivePrompt = `Generate 10 multiple-choice questions on active and passive voice. For each question, provide a sentence, a transformation task (e.g., 'Change to passive voice'), four options (one correct transformation, three plausible incorrect ones), and the correct answer. Crucially, ensure that the correct answer is truly randomized among the four options for *each* question and its position is never predictable (e.g., not always option 2 or 4). Also, ensure all four options have similar lengths (number of words/characters) to prevent the correct answer from being obvious due to length.`;
            const directIndirectPrompt = `Generate 10 multiple-choice questions on direct and indirect speech. For each question, provide a sentence, a transformation task (e.g., 'Change to indirect speech'), four options (one correct transformation, three plausible incorrect ones), and the correct answer. Crucially, ensure that the correct answer is truly randomized among the four options for *each* question and its position is never predictable (e.g., not always option 2 or 4). Also, ensure all four options have similar lengths (number of words/characters) to prevent the correct answer from being obvious due to length.`;

            document.getElementById('question-text').innerText = "Loading quiz questions...";

            const vocabF = await generateMCQs(vocabFPrompt, mcqSchema);
            const idiomsC = await generateMCQs(idiomsCPrompt, mcqSchema);
            const punctuation = await generateMCQs(punctuationPrompt, mcqSchema);
            const activePassive = await generateMCQs(activePassivePrompt, mcqSchema);
            const directIndirect = await generateMCQs(directIndirectPrompt, mcqSchema);

            quizData = [...vocabF, ...idiomsC, ...punctuation, ...activePassive, ...directIndirect];
            shuffleArray(quizData); // Shuffle all questions

            if (quizData.length === 50) {
                console.log("50 MCQs loaded successfully!");
            } else {
                console.warn(`Expected 50 MCQs, but got ${quizData.length}. Regenerating missing ones or using what's available.`);
                // If not 50, a more robust solution would involve iteratively generating until 50,
                // but for this example, we'll proceed with what we have or show a warning.
                // For a production app, you might re-prompt the LLM for missing categories.
            }
        }

        function renderQuestion() {
            if (currentQuestionIndex >= quizData.length) {
                showResult();
                return;
            }

            const question = quizData[currentQuestionIndex];
            questionText.innerHTML = question.question;
            optionsContainer.innerHTML = '';
            nextButton.classList.add('hidden'); // Hide next button until an option is selected

            const shuffledOptions = [...question.options];
            shuffleArray(shuffledOptions); // Shuffle options for each question

            shuffledOptions.forEach(option => {
                const button = document.createElement('button');
                button.classList.add('option-button');
                button.textContent = option;
                button.onclick = () => selectOption(button, option, question.correctAnswer);
                optionsContainer.appendChild(button);
            });

            const remainingQuestions = quizData.length - currentQuestionIndex -1;
            questionNumberSpan.textContent = `Question ${currentQuestionIndex + 1} of ${quizData.length} | Remaining: ${remainingQuestions}`;
        }

        function selectOption(selectedButton, selectedAnswer, correctAnswer) {
            if (quizStarted) { // Only allow selection if quiz has started and not ended
                // Disable all options after selection
                Array.from(optionsContainer.children).forEach(button => {
                    button.disabled = true;
                });

                if (selectedAnswer === correctAnswer) {
                    selectedButton.classList.add('correct');
                    score++;
                } else {
                    selectedButton.classList.add('wrong');
                    // Find and mark the correct answer
                    Array.from(optionsContainer.children).forEach(button => {
                        if (button.textContent === correctAnswer) {
                            button.classList.add('correct');
                        }
                    });
                }
                nextButton.classList.remove('hidden'); // Show next button
            }
        }

        function nextQuestion() {
            currentQuestionIndex++;
            renderQuestion();
        }

        function showResult() {
            clearInterval(timerInterval);
            quizSection.classList.add('hidden');
            resultSection.classList.remove('hidden');
            finalCandidateName.textContent = userName;
            finalScoreSpan.textContent = score;
            quizStarted = false; // Prevent further interactions
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                timeLeft--;
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                timerSpan.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    showResult();
                }
            }, 1000);
        }

        loginButton.addEventListener('click', () => {
            const id = idInput.value;
            const password = passwordInput.value;

            if (id === 'QQQ' && password === 'AAA') {
                loginError.classList.add('hidden');
                loginSection.classList.add('hidden');
                nameEntrySection.classList.remove('hidden');
            } else {
                loginError.classList.remove('hidden');
            }
        });

        startQuizButton.addEventListener('click', async () => {
            const name = nameInput.value.trim();
            if (name) {
                userName = name;
                nameError.classList.add('hidden');
                nameEntrySection.classList.add('hidden');
                quizSection.classList.remove('hidden');
                quizStarted = true;
                await loadQuizData(); // Load quiz data before rendering first question
                if (quizData.length > 0) {
                    renderQuestion();
                    startTimer();
                } else {
                    questionText.innerText = "Failed to load quiz questions. Please try again.";
                    nextButton.classList.add('hidden');
                }
            } else {
                nameError.classList.remove('hidden');
            }
        });

        nextButton.addEventListener('click', nextQuestion);

        // Initial render: show login section
        loginSection.classList.remove('hidden');
    </script>
</body>
</html>
