<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plato's Philosophy Quiz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f8ff; /* Alice Blue */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 700px;
            box-sizing: border-box;
        }
        .question-container {
            margin-bottom: 20px;
        }
        .option-button {
            display: block;
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            background-color: #f8f8f8;
            text-align: left;
            cursor: pointer;
            transition: background-color 0.3s, border-color 0.3s, transform 0.2s;
            font-size: 16px;
            color: #333;
        }
        .option-button:hover:not(.correct):not(.incorrect):not(.disabled) {
            background-color: #e6e6e6;
            border-color: #d0d0d0;
            transform: translateY(-2px);
        }
        .option-button.correct {
            background-color: #d4edda; /* Light green */
            border-color: #28a745;
            color: #155724;
            font-weight: bold;
        }
        .option-button.incorrect {
            background-color: #f8d7da; /* Light red */
            border-color: #dc3545;
            color: #721c24;
            font-weight: bold;
        }
        .option-button.disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }
        .start-screen, .end-screen, .auth-screen {
            text-align: center;
        }
        .timer-bar-container {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 5px;
            margin-top: 15px;
            overflow: hidden;
        }
        .timer-bar {
            height: 15px;
            background-color: #4CAF50; /* Green */
            width: 100%;
            border-radius: 5px;
            transition: width linear;
        }
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #fff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.2);
            z-index: 1000;
            text-align: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
            max-width: 90%;
        }
        .message-box.show {
            opacity: 1;
            visibility: visible;
        }
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .overlay.show {
            opacity: 1;
            visibility: visible;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="container">
        <!-- Auth Screen -->
        <div id="auth-screen" class="auth-screen">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">Welcome to Plato's Philosophy Quiz!</h2>
            <div class="mb-4">
                <input type="text" id="admin-id" placeholder="Enter ID" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="mb-6">
                <input type="password" id="admin-password" placeholder="Enter Password" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <button id="auth-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition duration-300 transform hover:scale-105">
                Login
            </button>
            <p id="auth-message" class="text-red-500 mt-3"></p>
        </div>

        <!-- Start Screen -->
        <div id="start-screen" class="start-screen hidden">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">Plato's Philosophy Quiz</h2>
            <p class="mb-4 text-gray-700">Test your knowledge on Plato's early life, famous quotes, and core philosophical ideas.</p>
            <div class="mb-6">
                <input type="text" id="candidate-name" placeholder="Enter your name" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <button id="start-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition duration-300 transform hover:scale-105">
                Start Quiz
            </button>
            <p id="name-error" class="text-red-500 mt-3"></p>
        </div>

        <!-- Quiz Screen -->
        <div id="quiz-screen" class="hidden">
            <div class="flex justify-between items-center mb-4">
                <p class="text-lg font-semibold text-gray-700">Question <span id="question-number">1</span> / <span id="total-questions">20</span></p>
                <div class="flex items-center">
                    <p class="text-lg font-semibold text-gray-700 mr-2">Time Left:</p>
                    <span id="timer" class="text-lg font-bold text-blue-600">15:00</span>
                </div>
            </div>
            <div class="timer-bar-container">
                <div id="timer-bar" class="timer-bar" style="width: 100%;"></div>
            </div>
            <div class="question-container mt-6">
                <p id="question-text" class="text-xl font-medium mb-4 text-gray-900"></p>
                <div id="options-container">
                    <!-- Options will be loaded here by JavaScript -->
                </div>
            </div>
            <button id="next-button" class="mt-6 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition duration-300 transform hover:scale-105 w-full">
                Next Question
            </button>
        </div>

        <!-- End Screen -->
        <div id="end-screen" class="end-screen hidden">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">Quiz Completed!</h2>
            <p class="text-xl mb-4 text-gray-700">Candidate: <span id="final-candidate-name" class="font-semibold"></span></p>
            <p class="text-xl mb-6 text-gray-700">Your Score: <span id="final-score" class="font-bold text-blue-600"></span> / <span id="final-total-questions" class="font-bold text-gray-800"></span></p>
            <p id="restart-message" class="text-red-500 mt-4 hidden">You cannot restart the quiz.</p>
        </div>
    </div>

    <!-- Message Box for alerts -->
    <div id="message-box" class="message-box hidden">
        <p id="message-content" class="text-lg text-gray-800 mb-4"></p>
        <button id="message-box-ok-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow transition duration-300">OK</button>
    </div>
    <div id="overlay" class="overlay hidden"></div>

    <script type="module">
        // Import Firebase modules for authentication and Firestore
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase configuration and global variables (provided by Canvas environment)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase
        let app;
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;

        /**
         * Initializes Firebase application and services.
         * Sets up authentication listener and signs in the user.
         */
        const initFirebase = async () => {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Firebase user ID:", userId);
                    } else {
                        // Sign in anonymously if no token or token sign-in fails
                        try {
                            const anonymousUser = await signInAnonymously(auth);
                            userId = anonymousUser.user.uid;
                            console.log("Signed in anonymously. User ID:", userId);
                        } catch (anonError) {
                            console.error("Anonymous sign-in failed:", anonError);
                            showMessage("Authentication Error", "Failed to sign in anonymously. Quiz data may not be saved.");
                        }
                    }
                    isAuthReady = true;
                    // For admin access to results, log the userId to console.
                    console.log("Admin Access: Your current user ID is:", userId);
                });

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showMessage("Initialization Error", "Failed to initialize Firebase. Quiz functionality may be limited.");
            }
        };

        // Call Firebase initialization
        initFirebase();

        // DOM elements
        const authScreen = document.getElementById('auth-screen');
        const adminIdInput = document.getElementById('admin-id');
        const adminPasswordInput = document.getElementById('admin-password');
        const authButton = document.getElementById('auth-button');
        const authMessage = document.getElementById('auth-message');

        const startScreen = document.getElementById('start-screen');
        const candidateNameInput = document.getElementById('candidate-name');
        const startButton = document.getElementById('start-button');
        const nameError = document.getElementById('name-error');

        const quizScreen = document.getElementById('quiz-screen');
        const questionNumberSpan = document.getElementById('question-number');
        const totalQuestionsSpan = document.getElementById('total-questions');
        const timerSpan = document.getElementById('timer');
        const timerBar = document.getElementById('timer-bar');
        const questionText = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const nextButton = document.getElementById('next-button');

        const endScreen = document.getElementById('end-screen');
        const finalCandidateName = document.getElementById('final-candidate-name');
        const finalScoreSpan = document.getElementById('final-score');
        const finalTotalQuestionsSpan = document.getElementById('final-total-questions');
        const restartMessage = document.getElementById('restart-message');

        const messageBox = document.getElementById('message-box');
        const messageContent = document.getElementById('message-content');
        const messageBoxOkButton = document.getElementById('message-box-ok-button');
        const overlay = document.getElementById('overlay');

        // Quiz variables
        let currentQuestionIndex = 0;
        let score = 0;
        let timer;
        const TIME_LIMIT = 15 * 60; // 15 minutes in seconds
        let timeLeft = TIME_LIMIT;
        let quizStarted = false;
        let candidateName = '';
        let quizAttempted = false; // Flag to prevent re-taking the quiz

        // Quiz questions (20 MCQs)
        const questions = [
            {
                question: "Plato was born into an aristocratic family in which ancient Greek city-state?",
                options: ["Sparta", "Athens", "Corinth", "Thebes"],
                correct: "Athens"
            },
            {
                question: "What was Plato's original name?",
                options: ["Aristocles", "Socrates", "Aristotle", "Heraclitus"],
                correct: "Aristocles"
            },
            {
                question: "Plato's early life career was planned to be in what field?",
                options: ["Military", "Politics", "Art", "Medicine"],
                correct: "Politics"
            },
            {
                question: "Which major political event in Athens significantly impacted Plato's early views on politics?",
                options: ["Peloponnesian War", "Persian Wars", "Revolt of Mytilene", "Thirty Tyrants' rule"],
                correct: "Thirty Tyrants' rule"
            },
            {
                question: "Who was Plato's primary philosophical mentor?",
                options: ["Aristotle", "Pythagoras", "Socrates", "Parmenides"],
                correct: "Socrates"
            },
            {
                question: "The 'death sentence' and execution of Socrates led Plato to develop a deep distrust of what system?",
                options: ["Monarchy", "Democracy", "Oligarchy", "Tyranny"],
                correct: "Democracy"
            },
            {
                question: "Plato founded which influential school of philosophy in Athens?",
                options: ["The Lyceum", "The Academy", "The Stoa", "The Garden"],
                correct: "The Academy"
            },
            {
                question: "Which of these concepts is most central to Plato's philosophy as described in the text?",
                options: ["Materialism", "Hedonism", "Idealism (Theory of Forms)", "Skepticism"],
                correct: "Idealism (Theory of Forms)"
            },
            {
                question: "According to Plato, what is the ultimate good and source of all knowledge?",
                options: ["Pleasure", "Wealth", "The Form of the Good", "Personal opinion"],
                correct: "The Form of the Good"
            },
            {
                question: "In 'The Republic', Plato explores the concept of an ideal state governed by what type of rulers?",
                options: ["Warriors", "Farmers", "Philosopher-Kings", "Merchants"],
                correct: "Philosopher-Kings"
            },
            {
                question: "Plato believed that true knowledge is attained through what?",
                options: ["Sensory experience", "Divine revelation", "Rational thought and contemplation", "Social consensus"],
                correct: "Rational thought and contemplation"
            },
            {
                question: "Which virtue did Plato consider essential for both individual and societal well-being?",
                options: ["Courage", "Temperance", "Justice", "Piety"],
                correct: "Justice"
            },
            {
                question: "What famous allegory did Plato use to illustrate the difference between the material world and the world of Forms?",
                options: ["The Ship of State", "The Cave", "The Divided Line", "The Ring of Gyges"],
                correct: "The Cave"
            },
            {
                question: "Plato suggested that the soul has three parts. Which of these is NOT one of them?",
                options: ["Rational", "Spirited", "Appetitive", "Emotional"],
                correct: "Emotional"
            },
            {
                question: "What, according to Plato, is the aim of education in the ideal state?",
                options: ["To train soldiers", "To cultivate virtue and wisdom", "To teach practical skills", "To prepare for trade"],
                correct: "To cultivate virtue and wisdom"
            },
            {
                question: "Plato's theory of Forms posits that non-physical, perfect archetypes exist independently of what?",
                options: ["Human thought", "The physical world", "Language", "Time"],
                correct: "The physical world"
            },
            {
                question: "Which of the following is a quote attributed to Plato, reflecting his view on the importance of music in education?",
                options: [
                    "Music is a moral law. It gives soul to the universe, wings to the mind, flight to the imagination, and charm and gaiety to life and to everything.",
                    "The unexamined life is not worth living.",
                    "Man is the measure of all things.",
                    "Change is the only constant in life."
                ],
                correct: "Music is a moral law. It gives soul to the universe, wings to the mind, flight to the imagination, and charm and gaiety to life and to everything."
            },
            {
                question: "Plato's writings are predominantly in what literary form?",
                options: ["Poetry", "Essays", "Dialogues", "Monologues"],
                correct: "Dialogues"
            },
            {
                question: "Plato traveled to Greek cities in Southern Italy to study the doctrines of which mystic society?",
                options: ["Epicureans", "Stoics", "Pythagoreans", "Cynics"],
                correct: "Pythagoreans"
            },
            {
                question: "What did Plato believe about mathematical instruction in relation to the curriculum of the Academy?",
                options: [
                    "It was optional but encouraged.",
                    "It was essential and highly emphasized.",
                    "It was only for advanced students.",
                    "It was not relevant to philosophy."
                ],
                correct: "It was essential and highly emphasized."
            }
        ];

        // Admin credentials
        const ADMIN_ID = '1111';
        const ADMIN_PASSWORD = '2222';

        /**
         * Displays a custom message box to the user.
         * @param {string} title - The title of the message.
         * @param {string} content - The content of the message.
         */
        function showMessage(title, content) {
            messageContent.innerHTML = `<strong>${title}:</strong> ${content}`;
            messageBox.classList.add('show');
            overlay.classList.add('show');
            messageBoxOkButton.focus(); // Focus the OK button for accessibility
        }

        /**
         * Hides the custom message box.
         */
        function hideMessageBox() {
            messageBox.classList.remove('show');
            overlay.classList.remove('show');
        }

        // Event listener for the message box OK button
        messageBoxOkButton.addEventListener('click', hideMessageBox);
        overlay.addEventListener('click', hideMessageBox); // Hide message box if overlay is clicked

        /**
         * Authenticates the admin based on provided ID and password.
         */
        authButton.addEventListener('click', () => {
            const id = adminIdInput.value;
            const password = adminPasswordInput.value;

            if (id === ADMIN_ID && password === ADMIN_PASSWORD) {
                authMessage.textContent = '';
                authScreen.classList.add('hidden');
                startScreen.classList.remove('hidden');
            } else {
                authMessage.textContent = 'Invalid ID or Password. Please try again.';
                adminIdInput.value = '';
                adminPasswordInput.value = '';
            }
        });

        /**
         * Starts the quiz if a candidate name is entered and the quiz hasn't been attempted.
         */
        startButton.addEventListener('click', () => {
            if (quizAttempted) {
                showMessage("Quiz Already Taken", "You have already attempted this quiz. You cannot restart.");
                return;
            }

            candidateName = candidateNameInput.value.trim();
            if (candidateName) {
                nameError.textContent = '';
                startScreen.classList.add('hidden');
                quizScreen.classList.remove('hidden');
                totalQuestionsSpan.textContent = questions.length;
                startQuiz();
                quizStarted = true;
            } else {
                nameError.textContent = 'Please enter your name to start the quiz.';
            }
        });

        /**
         * Displays the current question and its options.
         */
        function displayQuestion() {
            const questionData = questions[currentQuestionIndex];
            questionText.textContent = questionData.question;
            optionsContainer.innerHTML = '';
            questionNumberSpan.textContent = currentQuestionIndex + 1;
            nextButton.style.display = 'none'; // Hide next button until an option is selected

            questionData.options.forEach(option => {
                const button = document.createElement('button');
                button.textContent = option;
                button.classList.add('option-button');
                button.setAttribute('data-option', option); // Store option text for comparison
                button.addEventListener('click', () => selectOption(button, option, questionData.correct));
                optionsContainer.appendChild(button);
            });
        }

        /**
         * Handles the selection of an option.
         * @param {HTMLButtonElement} selectedButton - The button element that was clicked.
         * @param {string} selectedOption - The text of the selected option.
         * @param {string} correctAnswer - The text of the correct answer for the current question.
         */
        function selectOption(selectedButton, selectedOption, correctAnswer) {
            // Disable all options after one is selected
            Array.from(optionsContainer.children).forEach(button => {
                button.classList.add('disabled');
                button.style.pointerEvents = 'none'; // Further disable pointer events
            });

            if (selectedOption === correctAnswer) {
                selectedButton.classList.add('correct');
                score++;
            } else {
                selectedButton.classList.add('incorrect');
                // Find and highlight the correct answer
                Array.from(optionsContainer.children).forEach(button => {
                    if (button.getAttribute('data-option') === correctAnswer) {
                        button.classList.add('correct');
                    }
                });
            }
            nextButton.style.display = 'block'; // Show next button
        }

        /**
         * Moves to the next question or ends the quiz if all questions are answered.
         */
        nextButton.addEventListener('click', () => {
            currentQuestionIndex++;
            if (currentQuestionIndex < questions.length) {
                displayQuestion();
            } else {
                endQuiz();
            }
        });

        /**
         * Starts the quiz timer.
         */
        function startTimer() {
            timer = setInterval(() => {
                timeLeft--;
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                timerSpan.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

                const progress = (timeLeft / TIME_LIMIT) * 100;
                timerBar.style.width = `${progress}%`;

                if (timeLeft <= 0) {
                    clearInterval(timer);
                    endQuiz();
                }
            }, 1000);
        }

        /**
         * Initializes and starts the quiz.
         */
        function startQuiz() {
            currentQuestionIndex = 0;
            score = 0;
            timeLeft = TIME_LIMIT;
            quizStarted = false; // Reset for potential multiple attempts in dev, though prevented by flag
            quizAttempted = false; // Reset this flag for safety, will be set true on endQuiz
            displayQuestion();
            startTimer();
        }

        /**
         * Ends the quiz, displays the score, and saves the result to Firestore.
         */
        async function endQuiz() {
            clearInterval(timer); // Stop the timer
            quizScreen.classList.add('hidden');
            endScreen.classList.remove('hidden');
            quizAttempted = true; // Mark quiz as attempted

            finalCandidateName.textContent = candidateName;
            finalScoreSpan.textContent = score;
            finalTotalQuestionsSpan.textContent = questions.length;

            // Save result to Firestore only if Firebase is initialized and authenticated
            if (isAuthReady && userId) {
                try {
                    // Public data: store in /artifacts/{appId}/public/data/quiz_results
                    const quizResultRef = doc(collection(db, `artifacts/${appId}/public/data/quiz_results`));
                    await setDoc(quizResultRef, {
                        candidateName: candidateName,
                        score: score,
                        totalQuestions: questions.length,
                        timestamp: serverTimestamp(),
                        userId: userId // Store the user ID for admin access
                    });
                    console.log("Quiz result saved to Firestore:", {
                        candidateName: candidateName,
                        score: score,
                        totalQuestions: questions.length,
                        userId: userId,
                        quizId: quizResultRef.id // Log the document ID
                    });
                    showMessage("Quiz Completed!", "Your score has been recorded.");
                } catch (e) {
                    console.error("Error adding document to Firestore: ", e);
                    showMessage("Error Saving Result", "There was an issue saving your quiz result. Please try again later.");
                }
            } else {
                console.warn("Firebase not ready or user not authenticated. Quiz result not saved.");
                showMessage("Quiz Completed!", "Your score is displayed, but could not be saved due to an authentication issue.");
            }
            restartMessage.classList.remove('hidden'); // Show the message preventing restart
        }

        // Initial display for the authentication screen
        document.addEventListener('DOMContentLoaded', () => {
            authScreen.classList.remove('hidden');
            adminIdInput.focus();
        });

    </script>
</body>
</html>
